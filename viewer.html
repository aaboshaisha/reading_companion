<!DOCTYPE html>
<html>
    <head>
        <title>Viewer</title>
        <!-- the core library that parses the pdf -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <!-- helper class to render text content onto text layer div -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">

        <style>
            #pdf-container { position: relative; }
            #text-layer { position: absolute; left:0; top:0; }
            #toolbar { display:flex; gap:50px;}
            #main-container { display: flex; min-height: 80vh; }
            #chat-container { width: 300px; }
            #chat-messages { max-height: 400px; overflow-y: auto; }


        </style>
    </head>
    <body>
        <div id='toolbar'>
            <div>
                <input type='file' id='open-pdf' accept='.pdf'>
            </div>
                
            <div>
                <button id='prev'>Previous</button>
                <span>
                    <span id='page-num'></span> / <span id='page-count'></span>
                </span>
                <button id='next'>Next</button>
            </div>

            <div>
                <button id='zoom-in'>+</button> | <button id='zoom-out'>-</button>
            </div>

        </div>

        <main id='main-container'>

            <!-- add container to have both canvas and text layer for selection -->
            <div id='pdf-container'>
                <canvas id='pdf-canvas'></canvas>
                <!-- textLayer is a pdfjs class that handles text positioning, scaling, and overlay on canvas for selection/search -->
                <div id='text-layer' class='textLayer'></div>
            </div>

            <div id='chat-container'>
                <div id='chat-messages'></div>
                <textarea id='chat-input' placeholder='Ask anything (Shift + Enter to add selection)'></textarea>
                <button id='send-btn'>Send</button>
            </div>

        </main>


        <script>
            // the worker runs heavy processing in separate thread (to keep page responsive)
            // tell pdfjs where worker file is
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

            const url = 'sample.pdf';
            let doc = null;
            let pnum = 1;
            let scale = 1.5;

            async function renderPage(num, scale) {
                // disable buttons while rendering
                document.getElementById('prev').disabled = true;
                document.getElementById('next').disabled = true;
                document.getElementById('zoom-in').disabled = true;
                document.getElementById('zoom-out').disabled = true;

                const page = await doc.getPage(num);
                // extracts all the text from the page along with positioning information for each character/word.
                const text = await page.getTextContent();
                const textDiv = document.getElementById('text-layer');
                textDiv.innerHTML = ''; // clear prev text

                const canvas = document.getElementById('pdf-canvas');
                // context is our toolkit - we give it instructions to draw
                const ctx = canvas.getContext('2d');
                // get page dims and make it 1.5x bigger 
                const viewport = page.getViewport({scale: scale});
                // set canvas size to match it
                canvas.height=viewport.height; canvas.width=viewport.width;
                // render the page.. ctx (toolkit to draw) and viewport(what size)
                await page.render({canvasContext:ctx, viewport:viewport}).promise;

                document.getElementById('pdf-container').style.setProperty('--scale-factor', viewport.scale);

                // render text layer
                pdfjsLib.renderTextLayer({ textContentSource: text, container: textDiv, viewport: viewport });

                // update page-num
                document.getElementById('page-num').innerHTML = num;

                // enable them when done
                document.getElementById('prev').disabled = false;
                document.getElementById('next').disabled = false;
                document.getElementById('zoom-in').disabled = false;
                document.getElementById('zoom-out').disabled = false;

            }

            // add click handler to buttons
            document.getElementById('next').addEventListener('click', function() {
                if (pnum < doc.numPages) {
                    pnum = pnum + 1;
                    renderPage(pnum, scale);
                }

            });

            document.getElementById('prev').addEventListener('click', function (){
                if (pnum > 1){
                    pnum = pnum - 1;
                    renderPage(pnum, scale);        
                }

            })


            document.getElementById('zoom-in').addEventListener('click', function() {
                if (scale < 4.0){
                    scale = scale + 0.25;
                    renderPage(pnum, scale); 
                }

            })

            document.getElementById('zoom-out').addEventListener('click', function() {
                if (scale > 0.35) {
                    scale = scale - 0.25;
                    renderPage(pnum, scale);
                }

            })


            // send selection to input area
            document.addEventListener('keydown', function(e){
                if (e.shiftKey && e.key == 'Enter') {
                    const selection = window.getSelection().toString();
                    document.getElementById('chat-input').value += '""""' + selection + '""""';
                }
            })


            document.getElementById('open-pdf').addEventListener('change', function(e){
                const file = e.target.files[0];
                const fileReader = new FileReader(); // browser api - reads file from user's computer
                // what happens when file loaded
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    // this.result: file data in raw binary
                    // UintArray8: wraps it as an array of unsigned 8-bit integers (bytes) - the format PDF.js expects
                    doc = await pdfjsLib.getDocument(typedarray).promise;
                    console.log('pdf loaded!!!');
                    pnum=1; // reset to page 1
                    document.getElementById('page-count').innerHTML = doc.numPages;
                    await renderPage(1, scale);
                }
                fileReader.readAsArrayBuffer(file);
            })


        </script>
    </body>
    </html>