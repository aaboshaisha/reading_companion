<!DOCTYPE html>
<html>
    <head>
        <title>Viewer</title>
        <!-- the core library that parses the pdf -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <!-- helper class to render text content onto text layer div -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">

        <style>
            #pdf-container { position: relative; flex:1;}
            #text-layer { position: absolute; left:0; top:0; }
            #toolbar { display:flex; gap:50px;}
            #main-container { display: flex; min-height: 80vh; }
            #chat-container { width: 300px; }
            #msgs { max-height: 400px; overflow-y: auto; }

            button.icon-btn { background:none; border:none; cursor:pointer;}
            /* Creates a circle with a colored top border */
            .spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                animation: spin 1s linear infinite;
            }

            /* defines the rotation animation */
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

        </style>

    </head>
    <body>
        <div id='toolbar'>
            <input type='file' id='open-pdf' accept='.pdf'>
            <button id='prev' class='icon-btn' disabled>&#9664;</button>
            <span><span id='page-num'></span> / <span id='page-count'></span></span>
            <button id='next' class='icon-btn' disabled>&#9654;</button>
            <span>
                <button id='zoom-out' class='icon-btn' style='font-size:24px;' disabled>&#8722;</button>

                <button id='zoom-in' class='icon-btn' style='font-size:24px;' disabled>&#43;</button>
            </span>
            <button id='settings-btn' class='icon-btn' style='font-size:24px;'>&#9881;</button>
        </div>


        <main id='main-container'>

            <!-- add container to have both canvas and text layer for selection -->
            <div id='pdf-container'>
                <canvas id='pdf-canvas'></canvas>
                <!-- textLayer: a pdfjs class that handles text positioning, scaling, and overlay on canvas for selection/search -->
                <div id='text-layer' class='textLayer'></div>
            </div>

            <div id='chat-container'>

                <div id='api-key-container' style='margin-top:10px; margin-bottom:10px; display: none;'>
                    <input type='text' id='api-key' placeholder='Enter API key'>
                    <button id='save-key' class='icon-btn'>&#128190;</button>
                </div>

                <div id='tab-buttons'>
                    <button id='chat-tab'>Chat</button>
                    <button id='notes-tab'>Notes</button>
                </div>

                <div id='chat-content'>
                    <div id='msgs'></div>
                    <!-- outer div controls visibility, inner is actual spinner -->
                    <div id='loading-spinner' style='display:none';>
                        <div class='spinner'></div>
                    </div>

                    <textarea id='chat-input' placeholder='Ask anything (Shift + Enter to add selection)'></textarea>
                    <button id='send-msg'>Send</button>
                    <button id='edit-last'>Edit Last</button>
                </div>

                <div id='notes-content' style='display:none;'>
                    <div id='notes-list'></div>
                    <textarea id='note-text' placeholder="Type your notes here..."></textarea>
                    <button id='save-note' class='icon-btn'>&#128190;</button>

                    <button id='download-notes'>Download Note</button>

                </div>
            </div>

        </div>

        </main>


        <script>
            // the worker runs heavy processing in separate thread (to keep page responsive)
            // tell pdfjs where worker file is
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

            let doc = null;
            let pnum = 1;
            let scale = 1.5;

            // load saved api key
            const savedKey = localStorage.getItem('apiKey');
            if (savedKey) {
                // alert('Loaded saved API key!');
                console.log('Loaded saved API key!');
            }

            function disableButtons(disabled) {
                const buttons = ['prev', 'next', 'zoom-in', 'zoom-out'];
                for (const id of buttons) {
                    document.getElementById(id).disabled = disabled;
                }
            }

            async function renderPage(num, scale) {
                disableButtons(true); // disable buttons while rendering

                const page = await doc.getPage(num); // extracts all the text from the page along with positioning information for each character/word.
                const text = await page.getTextContent();
                const textDiv = document.getElementById('text-layer');
                textDiv.innerHTML = ''; // clear prev text

                const canvas = document.getElementById('pdf-canvas');
                const ctx = canvas.getContext('2d'); // context is our toolkit - we give it instructions to draw
                const viewport = page.getViewport({scale: scale}); // get page dims and make it 1.5x bigger 
                canvas.height=viewport.height; canvas.width=viewport.width; // set canvas size to match it
                await page.render({canvasContext:ctx, viewport:viewport}).promise; // render the page.. ctx (toolkit to draw) and viewport(what size)

                document.getElementById('pdf-container').style.setProperty('--scale-factor', viewport.scale);
                pdfjsLib.renderTextLayer({ textContentSource: text, container: textDiv, viewport: viewport }); // render text layer
                document.getElementById('page-num').innerHTML = num; // update page-num
                disableButtons(false); // enable them when done

            }

            // Navigation buttons

            function nextPage() {
                if (pnum < doc.numPages) {
                    pnum = pnum + 1;
                    renderPage(pnum, scale);
                }
            }

            function prevPage() {
                if (pnum > 1) {
                    pnum = pnum - 1;
                    renderPage(pnum, scale);
                }
            }

            function zoomIn() {
                if (scale < 4.0) {
                    scale = scale + 0.25;
                    renderPage(pnum, scale);
                }
            }

            function zoomOut() {
                if (scale > 0.35) {
                    scale = scale - 0.25;
                    renderPage(pnum, scale);
                }
            }

            document.getElementById('next').addEventListener('click', nextPage);
            document.getElementById('prev').addEventListener('click', prevPage);
            document.getElementById('zoom-in').addEventListener('click', zoomIn);
            document.getElementById('zoom-out').addEventListener('click', zoomOut);

            // File upload
            document.getElementById('open-pdf').addEventListener('change', function(e){
                const file = e.target.files[0];
                const fileReader = new FileReader(); // browser api - reads file from user's computer
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    doc = await pdfjsLib.getDocument(typedarray).promise;
                    console.log('pdf loaded!!!');
                    pnum=1; // reset to page 1
                    document.getElementById('page-count').innerHTML = doc.numPages;
                    await renderPage(1, scale);
                }
                fileReader.readAsArrayBuffer(file);
            });

            // this.result: file data in raw binary
            // UintArray8: wraps it as an array of unsigned 8-bit integers (bytes) - the format PDF.js expects


            // Send selection to input area
            document.addEventListener('keydown', function(e){
                if (e.shiftKey && e.key == 'Enter') {
                    const selection = window.getSelection().toString();
                    document.getElementById('chat-input').value += '""""' + selection + '""""';
                }
            });


            // save api key
            document.getElementById('save-key').addEventListener('click', function () {
                const keyInput = document.getElementById('api-key');
                localStorage.setItem('apiKey', keyInput.value);
                keyInput.value = '';
                alert('Key saved!');
            });


            // show / hide api key input
            const apiDiv = document.getElementById('api-key-container');
            document.getElementById('settings-btn').addEventListener('click', function () {
                if (apiDiv.style.display == 'none') { apiDiv.style.display = 'block'; }
                else { apiDiv.style.display = 'none';}
            });

            // Add messages
            function updateMessages(msg) {
                const msgs = document.getElementById('msgs');
                const msgDiv = document.createElement('div');
                msgDiv.innerHTML = `
                <span>${msg}</span>
                <button class='icon-btn' onclick='deleteMessage(this)'>&#9003;</button>
                `;
                msgs.appendChild(msgDiv);
            }

            function deleteMessage(btn) { btn.parentElement.remove(); }

            // Chat Functions

            // Send message
            async function sendMessage() {
                const chatInput = document.getElementById('chat-input');
                const userMsg = chatInput.value;
                chatInput.value = '';
                updateMessages(userMsg);
                document.getElementById('loading-spinner').style.display = 'block';
                const botMsg = await getResponse(userMsg);
                document.getElementById('loading-spinner').style.display = 'none';
                if (botMsg) { updateMessages(botMsg); }
            }

            document.getElementById('send-msg').addEventListener('click', sendMessage);


            function configOptions(apiKey, msg) {
                return {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        messages: [
                            {role: 'system', content: 'You are a helpful assistant'},
                            {role: 'user', content: msg}
                        ],
                        model: 'deepseek-chat', max_tokens: 4096, temperature: 1
                    })
                };
            }


            async function getResponse(userMsg) {
                const api_key = localStorage.getItem('apiKey');
                if (!api_key){ alert('Please enter api key first!'); return; }

                const url = 'https://api.deepseek.com/chat/completions';
                try {
                    const response = await fetch(url, configOptions(api_key, userMsg));
                    if (!response.ok){ 
                        throw new Error('API error: ' + response.status); 
                    }
                    const data = await response.json(); // response JSON string to JS object
                    return data.choices[0].message.content;
                } catch (error){ 
                    alert(error);
                    const msgs = document.getElementById('msgs');
                    document.getElementById('chat-input').value = msgs.lastElementChild.textContent;
                    msgs.lastElementChild.remove();
                    return;
                }

            }

            // edit last user message
            document.getElementById('edit-last').addEventListener('click', function (){
                const msgs = document.getElementById('msgs');
                if (msgs.children.length > 0){
                    msgs.lastElementChild.remove(); // remove AI response
                    document.getElementById('chat-input').value = msgs.lastElementChild.textContent;
                    msgs.lastElementChild.remove(); // remove User message
                }
            });


            // Notes interface
            function showChat() {
                document.getElementById('chat-content').style.display = 'block';
                document.getElementById('notes-content').style.display = 'none';
            }

            function showNotes() {
                document.getElementById('chat-content').style.display = 'none';
                document.getElementById('notes-content').style.display = 'block';
            }

            document.getElementById('chat-tab').addEventListener('click', showChat);
            document.getElementById('notes-tab').addEventListener('click', showNotes);


            let currentEditNote = null;
            function saveNote(){
                const notesArea = document.getElementById('notes-list');
                const textArea = document.getElementById('note-text');

                if (currentEditNote) {
                    currentEditNote.querySelector('span').textContent = textArea.value;
                    currentEditNote = null; // reset
                }
                else{
                    // create new note Div
                    const noteDiv = document.createElement('div');
                    noteDiv.innerHTML = `
                    <span>${textArea.value}</span>
                    <button class='icon-btn' onclick="editNote(this)">&#9998;</button>
                    <button class='icon-btn' onclick="deleteNote(this)">&#9003;</button>
                    `;
                    notesArea.appendChild(noteDiv);
                }
                textArea.value = '';
            }

            document.getElementById('save-note').addEventListener('click', saveNote);

            function deleteNote(btn) { btn.parentElement.remove(); }

            function editNote(btn) {
                const noteDiv = btn.parentElement;
                const noteText = noteDiv.querySelector('span').textContent;
                document.getElementById('note-text').value = noteText; // put it in textarea
                currentEditNote = noteDiv; // remember which note we're editing
            }

            // saving notes to device
            // 1. Create the data - Package your notes into a format (like JSON or plain text)
            // 2. Create a Blob - A Blob is a "file-like object" that exists in the browser's memory. It holds your data.
            // 3. Create a download URL - Generate a special URL that points to this Blob
            // 4. Trigger a download - Create an invisible link (an <a> tag) with this URL and programmatically click it. This prompts the browser to download the file.
            // 5. Clean up - Remove the temporary URL from memory
            // Think of it like: You're creating a temporary file in the browser, then tricking the browser into downloading it as if it came from a server.

            function downloadNotes() {
                const notesDiv = document.querySelectorAll('#noteslist div');
                const notesArray = [];
                for (const ndiv of notesDiv){
                    const text = document.querySelector('span').textContent;
                    notesArray.push(text);
                }
                const jsonStr = JSON.stringify(notesArray);
                const blob = new Blob([jsonStr], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'notes.json';
                a.click();
                URL.revokeObjectURL(url);
            }




        </script>
    </body>
    </html>